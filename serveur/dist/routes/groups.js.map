{"version":3,"sources":["../../routes/groups.js"],"names":["express","require","router","Router","db","squelb","squel","useFlavour","get","req","res","iduser","params","groups","getUsersInGroups","any","then","tableau","toReturn","buildGroupsObject","send","status","message","catch","e","toString","getGroups","select","from","field","where","left_join","queryResult","forEach","element","index","contains","idPosition","idgroup","grelement","push","nomgroup","membres","idGroupeConcerne","grindex","prenom","nomuser","parseInt","requete","getGroupPinpoints","result","JSONToReturn","pinpoints","userpositions","pinpoint","idpinpoint","idcreator","pinlt","pinlg","description","daterdv","getUsersPositions","userCorrectRequest","console","log","userposition","userlt","userglt","userlg","userglg","current","dateposition","err","module","exports"],"mappings":"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","file":"groups.js","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst db = require('../connection');\r\nconst squelb = require('squel');\r\nconst squel = squelb.useFlavour('postgres');\r\n\r\n//donne les groupes auxquels appartient un utilisateur + les membres du groupe\r\nrouter.get('/:iduser/', function (req, res) {\r\n    let iduser = req.params.iduser;\r\n    let groups = getUsersInGroups(iduser);\r\n    db.any(groups)\r\n        .then((tableau) => {\r\n            let toReturn = buildGroupsObject(tableau);\r\n            res.send({\r\n                status: 'success',\r\n                message: toReturn\r\n            });\r\n            //sender.sendResponse(sender.SUCCESS_STATUS, toReturn, res);\r\n\r\n        })\r\n        .catch(e => {\r\n            res.status(400);\r\n            res.send({\r\n                status: 'fail',\r\n                message: e.toString()\r\n            });\r\n            //sender.sendResponse(sender.NOT_FOUND_STATUS, toReturn, res);\r\n        });\r\n\r\n});\r\n\r\nlet getGroups = (iduser) =>\r\n    squel.select()\r\n        .from('public.\"USER_GROUP\"', 'ugr')\r\n        .field('ugr.idgroup')\r\n        .field('gr.nom')\r\n        .where('ugr.iduser = ?', iduser)\r\n        .left_join('public.\"GROUP\"', 'gr', 'ugr.idgroup = gr.idgroup')\r\n;\r\n\r\nlet getUsersInGroups = (iduser) =>\r\n    squel.select()\r\n        .from(getGroups(iduser), 'listgroups')\r\n        .left_join('public.\"USER_GROUP\"', 'ugr', 'ugr.idgroup = listgroups.idgroup')\r\n        .left_join('public.\"USER\"', 'usr', 'usr.iduser = ugr.iduser')\r\n        .field('usr.prenom')\r\n        .field('usr.nom', 'nomuser')\r\n        .field('usr.iduser')\r\n        .field('listgroups.nom', 'nomgroup')\r\n        .field('ugr.idgroup')\r\n        .toString();\r\n\r\nfunction buildGroupsObject(queryResult) {\r\n    var groups = [];\r\n    queryResult.forEach((element, index) => {\r\n        // le resultat de la requete donne un tableau de {prenom, nomuser, iduser, nomgroup, idgroup}\r\n        let contains = false;\r\n        let idPosition;\r\n        // si l'id du groupe n'existe pas encore dans le tableau, on le push et on crée un ligne pour le groupe\r\n        groups.forEach(grelement => {\r\n            if (element.idgroup === grelement.idgroup) {\r\n                contains = true;\r\n                idPosition = index;\r\n            }\r\n        });\r\n        if (!contains) {\r\n            groups.push({idgroup: element.idgroup, nomgroup: element.nomgroup, membres: []})\r\n        }\r\n    });\r\n    //une fois le tableau des groupes créé, on push les membres dans groups[idGroupConcerné].membres\r\n    queryResult.forEach((element) => {\r\n        let idGroupeConcerne;\r\n        //on get la position dans groups du groupe concerné pour l'user (element)\r\n        groups.forEach((grelement, grindex) => {\r\n            if (grelement.idgroup === element.idgroup) {\r\n                idGroupeConcerne = grindex;\r\n                groups[idGroupeConcerne].membres.push({\r\n                    iduser: element.iduser,\r\n                    prenom: element.prenom,\r\n                    nomuser: element.nomuser\r\n                });\r\n            }\r\n        })\r\n    });\r\n    return groups;\r\n\r\n}\r\n\r\n// https://stackoverflow.com/questions/16767301/calculate-difference-between-2-timestamps-using-javascript\r\n// Pour check les daaaates hehehe\r\n\r\n\r\n// les infos d'un groupe en particulier (les pinpoints et les positions des utilisateurs du groupe\r\nrouter.get('/positions/:iduser/:idgroup', function(req,res){\r\n    //vérifier si l'utilisateur est bien dans le groupe avant de faire le traitement\r\n   let iduser = parseInt(req.params.iduser, 10);\r\n   let idgroup = req.params.idgroup;\r\n//pour le groupe : renvoyer son nom, les pinpoints qui lui sont associés, les dessins,\r\n// les positions des gens SSI ils décident de la partager avec ce groupe\r\n    let requete = getGroupPinpoints(idgroup);\r\n    db.any(requete)\r\n        .then((result) =>{\r\n            let JSONToReturn = {idgroup: idgroup, pinpoints:[], userpositions:[]};\r\n            result.forEach(element => {\r\n                // CHECK SI LA DATE est supérieure de 1 jour de plus de la date de RDV. sinon ne\r\n                //pas renvoyer\r\n                let pinpoint = {\r\n                    idpinpoint: element.idpinpoint,\r\n                    idcreator: element.idcreator,\r\n                    pinlt: element.pinlt,\r\n                    pinlg:element.pinlg,\r\n                    description:element.description,\r\n                    daterdv:element.daterdv\r\n                };\r\n                //si la date est ok on le push dans l'array\r\n                JSONToReturn.pinpoints.push(pinpoint);\r\n            });\r\n            db.any(getUsersPositions(idgroup))\r\n                .then((userpositions) => {\r\n                    let userCorrectRequest = false;\r\n                    userpositions.forEach(element =>{\r\n                        console.log(typeof element.iduser);\r\n                        console.log(typeof iduser);\r\n                        if(element.iduser === iduser){\r\n                            userCorrectRequest = true; // on vérifie ici si le gars qui demande est bien dans le groupe\r\n                        }\r\n                        let userposition = {\r\n                           iduser: element.iduser,\r\n                           userlt:element.userglt,\r\n                           userlg:element.userglg,\r\n                           current:true, // A CHANGER CO LO APRES LE TRAITEMENT LO\r\n                           dateposition:element.dateposition\r\n                       };\r\n                       JSONToReturn.userpositions.push(userposition);\r\n                    });\r\n\r\n                    if(userCorrectRequest){\r\n                        res.send({\r\n                            status: 'success',\r\n                            message: JSONToReturn\r\n                        });\r\n                    }\r\n                    else{\r\n                        res.status(400);\r\n                        res.send({\r\n                            status:'fail',\r\n                            message: 'You requested the informations of a group in which you DON\\'T belong, bitch'\r\n                        })\r\n                    }\r\n\r\n                })\r\n                .catch(err => {\r\n                    res.status(400);\r\n                    res.send({\r\n                        status: 'fail',\r\n                        message: err.toString()\r\n                    })\r\n                })\r\n        })\r\n        .catch(e => {\r\n            res.status(400);\r\n            res.send({\r\n                status: 'fail',\r\n                message: e.toString()\r\n            })\r\n        });\r\n    console.log(requete);\r\n\r\n\r\n});\r\n\r\nlet getGroupPinpoints = (idgroup) =>\r\n    squel.select()\r\n        .from('public.\"GROUP\"', 'gr')\r\n        .field('gr.nom', 'nomgroup')\r\n        .field('gr.idgroup')\r\n        .field('pin.idcreator')\r\n        .field('pin.idpinpoint')\r\n        .field('pin.pinlt')\r\n        .field('pin.pinlg')\r\n        .field('pin.description')\r\n        .field('pin.daterdv')\r\n        .left_join('public.\"PINPOINT\"', 'pin', 'pin.idgroup = gr.idgroup')\r\n        .where('gr.idgroup = ?', idgroup)\r\n        .toString();\r\n\r\nlet getUsersPositions = (idgroup) =>\r\n    squel.select()\r\n        .from('public.\"GROUP\"', 'gr')\r\n        .field('ugr.iduser')\r\n        .field('ugr.sharesposition')\r\n        .field('ugr.userglt')\r\n        .field('ugr.userglg')\r\n        .field('ugr.dateposition')\r\n        .left_join('public.\"USER_GROUP\"', 'ugr', 'ugr.idgroup = gr.idgroup')\r\n        .where('gr.idgroup = ?', idgroup)\r\n        .toString();\r\n\r\n\r\n\r\nmodule.exports = router;\r\n"]}