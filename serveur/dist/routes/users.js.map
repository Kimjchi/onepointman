{"version":3,"sources":["../../routes/users.js"],"names":["express","require","router","Router","axios","db","squelb","squel","useFlavour","sender","facebookdata","get","req","res","next","send","userAccessToken","post","toUpdate","iduser","body","userlg","userlt","getGroups","select","from","field","where","parseInt","toString","any","then","groups","currentTime","Date","updateUserTable","update","table","set","toISOString","none","console","log","forEach","element","sharesposition","query","idgroup","catch","status","message","e","positionSharing","sendResponse","SUCCESS_STATUS","NOT_FOUND_STATUS","delete","user_id","params","userFriendList","friendlist","_getUserFriendList","response","data","error","userFriendListRequest","redirectURI","userID","module","exports"],"mappings":"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","file":"users.js","sourcesContent":["var express = require('express');\r\nvar router = express.Router();\r\nconst axios = require('axios');\r\n\r\nconst db = require('../connection');\r\nconst squelb = require('squel');\r\nconst squel = squelb.useFlavour('postgres');\r\n\r\nconst sender = require('../sender');\r\nconst facebookdata = require(\"../facebookdata\");\r\n\r\n/* GET users listing. */\r\nrouter.get('/', function (req, res, next) {\r\n    res.send('respond with a resource user id :' + facebookdata.userAccessToken);\r\n});\r\n\r\nrouter.post(('/updateposition'), function (req, res) {\r\n\r\n    let toUpdate = {\r\n        iduser: req.body.iduser,\r\n        userlg: req.body.userlg,\r\n        userlt: req.body.userlt,\r\n    };\r\n\r\n    let getGroups = squel.select()\r\n        .from('public.\"USER_GROUP\"', 'ugr')\r\n        .field('ugr.idgroup')\r\n        .field('ugr.sharesposition')\r\n        .where('ugr.iduser = ?', parseInt(toUpdate.iduser, 10))\r\n        .toString();\r\n    db.any(getGroups)\r\n        .then((groups) =>{\r\n            let currentTime = new Date();\r\n            let updateUserTable = squel.update()\r\n                .table('public.\"USER\"')\r\n                .set('lg', toUpdate.userlg)\r\n                .set('lt',toUpdate.userlt)\r\n                .set('dateposition', currentTime.toISOString())\r\n                .where('iduser = ?', toUpdate.iduser)\r\n                .toString();\r\n            db.none(updateUserTable)\r\n                .then(() => {\r\n                    console.log('Updated position of user in USER ');\r\n                    console.log(groups);\r\n                    groups.forEach(element => {\r\n                        //pour chaque groupe, s'il dÃ©cide de partager sa position avec, on update sa position\r\n                        if (element.sharesposition === true) {\r\n                            let query = squel.update()\r\n                                .table('public.\"USER_GROUP\"')\r\n                                .set('userglt', toUpdate.userlt)\r\n                                .set('userglg', toUpdate.userlg)\r\n                                .set('dateposition', currentTime.toISOString())\r\n                                .where('iduser = ?', toUpdate.iduser)\r\n                                .toString();\r\n                            db.none(query)\r\n                                .then(() => {\r\n                                    console.log('Updated position of user in group ' + element.idgroup);\r\n                                })\r\n                                .catch(e => {\r\n                                    res.status(400);\r\n                                    res.send({\r\n                                        status: 'fail',\r\n                                        message: 'failing to update userposition in a group'\r\n                                    })\r\n                                })\r\n                        }\r\n\r\n                })\r\n            });\r\n\r\n            res.send({\r\n                status: 'success',\r\n                message: 'Position updated successfully'\r\n            })\r\n        })\r\n        .catch(e => {\r\n            res.status(400);\r\n            res.send({\r\n                status: 'fail',\r\n                message: e.toString()\r\n            })\r\n        });\r\n});\r\n\r\nrouter.post(('/updatepositionsharing'), function(req, res){\r\n\r\n    let toUpdate = {\r\n        iduser : req.body.iduser,\r\n        idgroup : req.body.idgroup,\r\n        positionSharing : req.body.positionSharing,\r\n    };\r\n\r\n    let query = squel.update()\r\n        .table('public.\"USER_GROUP\"')\r\n        .set('sharesposition', toUpdate.positionSharing)\r\n        .where('iduser = ?', toUpdate.iduser)\r\n        .where('idgroup = ?', toUpdate.idgroup)\r\n        .toString();\r\n\r\n    db.query(query)\r\n        .then(()=>{\r\n            sender.sendResponse(sender.SUCCESS_STATUS, 'Position sharing updated successfully', res)\r\n        })\r\n        .catch(e => {\r\n            sender.sendResponse(sender.NOT_FOUND_STATUS, 'Error while updating position sharing', res);\r\n            console.log(e);\r\n        })\r\n});\r\n\r\nrouter.delete(('/deleteuser'), function(req, res){\r\n\r\n    let toUpdate = {\r\n        iduser : req.body.iduser,\r\n        idgroup : req.body.idgroup,\r\n    };\r\n\r\n    let query = squel.delete()\r\n        .from('public.\"USER_GROUP\"')\r\n        .where('iduser = ?', toUpdate.iduser)\r\n        .where('idgroup = ?', toUpdate.idgroup)\r\n        .toString();\r\n\r\n    db.query(query)\r\n        .then(()=>{\r\n            sender.sendResponse(sender.SUCCESS_STATUS, 'User deleted from group successfully', res)\r\n        })\r\n        .catch(e => {\r\n            sender.sendResponse(sender.NOT_FOUND_STATUS, 'Error while deleting user from group', res);\r\n            console.log(e);\r\n        })\r\n});\r\n\r\nrouter.get('/userFriends/:user_id/', function (req, res) {\r\n    console.log(\"GET /userFriends/:user_id/\");\r\n\r\n    let user_id = req.params.user_id;\r\n    let userFriendList = {\r\n        friendlist : []\r\n    };\r\n\r\n    _getUserFriendList(user_id)\r\n        .then(response => {\r\n            userFriendList.friendlist = response.data.data;\r\n\r\n            console.log('userFriendList : ' + userFriendList);\r\n\r\n            sender.sendResponse(sender.SUCCESS_STATUS, userFriendList, res)\r\n        })\r\n        .catch(error => {\r\n        console.log(error)\r\n    });\r\n});\r\n\r\nconst _getUserFriendList = (user_id) => {\r\n    let userFriendListRequest = {\r\n        redirectURI: 'https://graph.facebook.com/v2.11/',\r\n        userAccessToken: facebookdata.userAccessToken,\r\n        userID: user_id\r\n    };\r\n\r\n    return axios.get(userFriendListRequest.redirectURI + userFriendListRequest.userID + '/friends?access_token=' + userFriendListRequest.userAccessToken)\r\n};\r\n\r\nmodule.exports = router;\r\n"]}